name: Release

on:
  push:
    branches:
      - "v1.2-beta"
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build & Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"

      - name: Build Binaries
        run: |
          mkdir -p dist
          # Linux
          GOOS=linux GOARCH=amd64 go build -ldflags "-s -w" -o dist/cloudslash_linux_amd64 ./cmd/cloudslash
          # Linux (ARM64)
          GOOS=linux GOARCH=arm64 go build -ldflags "-s -w" -o dist/cloudslash_linux_arm64 ./cmd/cloudslash
          # Windows
          GOOS=windows GOARCH=amd64 go build -ldflags "-s -w" -o dist/cloudslash_windows_amd64.exe ./cmd/cloudslash
          # macOS (Intel)
          GOOS=darwin GOARCH=amd64 go build -ldflags "-s -w" -o dist/cloudslash_darwin_amd64 ./cmd/cloudslash
          # macOS (Apple Silicon)
          GOOS=darwin GOARCH=arm64 go build -ldflags "-s -w" -o dist/cloudslash_darwin_arm64 ./cmd/cloudslash

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || 'beta-build' }}
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
          files: dist/*
          generate_release_notes: false
          body: |
            # CloudSlash v1.3.0: The Infrastructure Surgeon

            > **The Local-First Forensic Cloud Accountant.**
            > CloudSlash goes beyond simple "unused" checks by analyzing the **lifecycle** and **relationships** of your infrastructure.

            ### ‚ö° Quick Install

            ```bash
            # macOS / Linux
            curl -sL https://raw.githubusercontent.com/DrSkyle/CloudSlash/main/dist/install.sh | bash

            # Windows (PowerShell)
            irm https://raw.githubusercontent.com/DrSkyle/CloudSlash/main/dist/install.ps1 | iex
            ```

            ### üîç Key Capabilities in v1.3.0

            - **The State Doctor**: Bridges AWS Reality to Terraform State. Generates `fix_terraform.sh` to surgically remove waste.
            - **The Network Surgeon**: Identifies "Hollow" NAT Gateways (active but serving empty subnets) & Safe-Release EIPs (DNS-verified).
            - **The Storage Janitor**: Finds hidden S3 Multipart Upload debris & legacy `gp2` volumes eligible for modernization.
            - **The App Cleaner**: Prunes old Lambda versions (respecting aliases) & identifies Redshift Pause candidates.
            - **The Log Hunter**: Audits abandoned CloudWatch Log Groups (>30 days silence).

            ### ‚ù§Ô∏è Social Impact Pledge

            CloudSlash is 100% independent and bootstrapped. We pledge a portion of every Commercial License to support orphanages and animal rescue shelters in developing communities.

            ---

            [Full Changelog](https://github.com/DrSkyle/CloudSlash/compare/v1.2.9...v1.3.0)
          draft: false
